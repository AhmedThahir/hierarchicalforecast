---

title: Hierachical Reconciliation Methods


keywords: fastai
sidebar: home_sidebar

summary: "Classes in this module have the `reconcile` method capable of reconcile base forecasts using `numpy` arrays.  "
description: "Classes in this module have the `reconcile` method capable of reconcile base forecasts using `numpy` arrays.  "
nb_path: "nbs/methods.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/methods.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="BottomUp" class="doc_header"><code>class</code> <code>BottomUp</code><a href="https://github.com/Nixtla/hierarchicalforecast/tree/main/hierarchicalforecast/methods.py#L33" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>BottomUp</code>()</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="BottomUp.reconcile" class="doc_header"><code>BottomUp.reconcile</code><a href="https://github.com/Nixtla/hierarchicalforecast/tree/main/hierarchicalforecast/methods.py#L35" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>BottomUp.reconcile</code>(<strong><code>S</code></strong>:<code>ndarray</code>, <strong><code>y_hat</code></strong>:<code>ndarray</code>, <strong><code>idx_bottom</code></strong>:<code>ndarray</code>)</p>
</blockquote>
<table>
<thead><tr>
<th></th>
<th>Type</th>
<th>Default</th>
<th>Details</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong><code>S</code></strong></td>
<td><code>ndarray</code></td>
<td></td>
<td>Summing matrix of size (<code>base</code>, <code>bottom</code>)</td>
</tr>
<tr>
<td><strong><code>y_hat</code></strong></td>
<td><code>ndarray</code></td>
<td></td>
<td>Forecast values of size (<code>base</code>, <code>horizon</code>)</td>
</tr>
<tr>
<td><strong><code>idx_bottom</code></strong></td>
<td><code>ndarray</code></td>
<td></td>
<td>Indices corresponding to the bottom level of <code>S</code>, size (<code>bottom</code>)</td>
</tr>
</tbody>
</table>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The most basic hierarchical reconciliation is performed using an Bottom-Up strategy. It was proposed for the first time by Orcutt in 1968.
The corresponding hierarchical "projection" matrix is defined as:</p>
<p>{% raw %}
$$\mathbf{P}_{\text{BU}} = [\mathbf{0}_{\mathrm{[b],[a]}}\;|\;\mathbf{I}_{\mathrm{[b][b]}}]$$
{% endraw %}</p>
<ul>
<li><a href="http://www.jstor.org/stable/1815532">Orcutt, G.H., Watts, H.W., &amp; Edwards, J.B.(1968). Data aggregation and information loss. The American Economic Review, 58 , 773{787)</a></li>
</ul>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="TopDown" class="doc_header"><code>class</code> <code>TopDown</code><a href="https://github.com/Nixtla/hierarchicalforecast/tree/main/hierarchicalforecast/methods.py#L137" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>TopDown</code>(<strong><code>method</code></strong>:<code>str</code>)</p>
</blockquote>
<table>
<thead><tr>
<th></th>
<th>Type</th>
<th>Default</th>
<th>Details</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong><code>method</code></strong></td>
<td><code>str</code></td>
<td></td>
<td>One of <code>forecast_proportions</code>, <code>average_proportions</code> and <code>proportion_averages</code></td>
</tr>
</tbody>
</table>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="TopDown.reconcile" class="doc_header"><code>TopDown.reconcile</code><a href="https://github.com/Nixtla/hierarchicalforecast/tree/main/hierarchicalforecast/methods.py#L145" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>TopDown.reconcile</code>(<strong><code>S</code></strong>:<code>ndarray</code>, <strong><code>y_hat</code></strong>:<code>ndarray</code>, <strong><code>y_insample</code></strong>:<code>ndarray</code>, <strong><code>levels</code></strong>:<code>Dict</code>[<code>str</code>, <code>ndarray</code>])</p>
</blockquote>
<table>
<thead><tr>
<th></th>
<th>Type</th>
<th>Default</th>
<th>Details</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong><code>S</code></strong></td>
<td><code>ndarray</code></td>
<td></td>
<td>Summing matrix of size (<code>base</code>, <code>bottom</code>)</td>
</tr>
<tr>
<td><strong><code>y_hat</code></strong></td>
<td><code>ndarray</code></td>
<td></td>
<td>Forecast values of size (<code>base</code>, <code>horizon</code>)</td>
</tr>
<tr>
<td><strong><code>y_insample</code></strong></td>
<td><code>ndarray</code></td>
<td></td>
<td>Insample values of size (<code>base</code>, <code>insample_size</code>)</td>
</tr>
<tr>
<td><strong><code>levels</code></strong></td>
<td><code>typing.Dict[str, numpy.ndarray]</code></td>
<td></td>
<td>Each key is a level and each value its <code>S</code> indices</td>
</tr>
</tbody>
</table>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The Top Down hierarchical reconciliation method, distributes the total aggregate predictions and decomposes it down the hierarchy using proportions $\mathbf{p}_{\mathrm{[b]}}$ that can be actual historical values or estimated.</p>
<p>{% raw %}
$$\mathbf{P}=[\mathbf{p}_{\mathrm{[b]}}\;|\;\mathbf{0}_{\mathrm{[b][a,b\;-1]}}]$$
{% endraw %}</p>
<ul>
<li><a href="https://onlinelibrary.wiley.com/doi/abs/10.1002/for.3980090304">Disaggregation methods to expedite product line forecasting. Journal of Forecasting, 9 , 233–254. doi:10.1002/for.3980090304</a></li>
<li><a href="https://doi.org/10.1016/S0305-0548(99">An investigation of aggregate variable time series forecast strategies with specific subaggregate time series statistical correlation. Computers and Operations Research, 26 , 1133–1149. doi:10.1016/S0305-0548(99)00017-9</a>00017-9)</li>
</ul>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="MiddleOut" class="doc_header"><code>class</code> <code>MiddleOut</code><a href="https://github.com/Nixtla/hierarchicalforecast/tree/main/hierarchicalforecast/methods.py#L226" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>MiddleOut</code>(<strong><code>level</code></strong>:<code>str</code>, <strong><code>top_down_method</code></strong>:<code>str</code>)</p>
</blockquote>
<table>
<thead><tr>
<th></th>
<th>Type</th>
<th>Default</th>
<th>Details</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong><code>level</code></strong></td>
<td><code>str</code></td>
<td></td>
<td>Middle level</td>
</tr>
<tr>
<td><strong><code>top_down_method</code></strong></td>
<td><code>str</code></td>
<td></td>
<td>One of <code>forecast_proportions</code>, <code>average_proportions</code> and <code>proportion_averages</code></td>
</tr>
</tbody>
</table>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="MiddleOut.reconcile" class="doc_header"><code>MiddleOut.reconcile</code><a href="https://github.com/Nixtla/hierarchicalforecast/tree/main/hierarchicalforecast/methods.py#L236" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>MiddleOut.reconcile</code>(<strong><code>S</code></strong>:<code>ndarray</code>, <strong><code>y_hat</code></strong>:<code>ndarray</code>, <strong><code>y_insample</code></strong>:<code>ndarray</code>, <strong><code>levels</code></strong>:<code>Dict</code>[<code>str</code>, <code>ndarray</code>])</p>
</blockquote>
<table>
<thead><tr>
<th></th>
<th>Type</th>
<th>Default</th>
<th>Details</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong><code>S</code></strong></td>
<td><code>ndarray</code></td>
<td></td>
<td>Summing matrix of size (<code>base</code>, <code>bottom</code>)</td>
</tr>
<tr>
<td><strong><code>y_hat</code></strong></td>
<td><code>ndarray</code></td>
<td></td>
<td>Forecast values of size (<code>base</code>, <code>horizon</code>)</td>
</tr>
<tr>
<td><strong><code>y_insample</code></strong></td>
<td><code>ndarray</code></td>
<td></td>
<td>Insample values of size (<code>base</code>, <code>insample_size</code>)</td>
</tr>
<tr>
<td><strong><code>levels</code></strong></td>
<td><code>typing.Dict[str, numpy.ndarray]</code></td>
<td></td>
<td>Each key is a level and each value its <code>S</code> indices</td>
</tr>
</tbody>
</table>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This method is only available for strictly hierarchical structures. It anchors the base predictions in a middle level. The levels above the base predictions use the bottom-up approach, while the levels below use a top-down.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="MinTrace" class="doc_header"><code>class</code> <code>MinTrace</code><a href="https://github.com/Nixtla/hierarchicalforecast/tree/main/hierarchicalforecast/methods.py#L305" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>MinTrace</code>(<strong><code>method</code></strong>:<code>str</code>)</p>
</blockquote>
<table>
<thead><tr>
<th></th>
<th>Type</th>
<th>Default</th>
<th>Details</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong><code>method</code></strong></td>
<td><code>str</code></td>
<td></td>
<td>One of <code>ols</code>, <code>wls_struct</code>, <code>wls_var</code>, <code>mint_shrink</code>, <code>mint_co</code></td>
</tr>
</tbody>
</table>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="MinTrace.reconcile" class="doc_header"><code>MinTrace.reconcile</code><a href="https://github.com/Nixtla/hierarchicalforecast/tree/main/hierarchicalforecast/methods.py#L313" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>MinTrace.reconcile</code>(<strong><code>S</code></strong>:<code>ndarray</code>, <strong><code>y_hat</code></strong>:<code>ndarray</code>, <strong><code>y_insample</code></strong>:<code>ndarray</code>, <strong><code>y_hat_insample</code></strong>:<code>ndarray</code>)</p>
</blockquote>
<table>
<thead><tr>
<th></th>
<th>Type</th>
<th>Default</th>
<th>Details</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong><code>S</code></strong></td>
<td><code>ndarray</code></td>
<td></td>
<td>Summing matrix of size (<code>base</code>, <code>bottom</code>)</td>
</tr>
<tr>
<td><strong><code>y_hat</code></strong></td>
<td><code>ndarray</code></td>
<td></td>
<td>Forecast values of size (<code>base</code>, <code>horizon</code>)</td>
</tr>
<tr>
<td><strong><code>y_insample</code></strong></td>
<td><code>ndarray</code></td>
<td></td>
<td>Insample values of size (<code>base</code>, <code>insample_size</code>)</td>
</tr>
<tr>
<td><strong><code>y_hat_insample</code></strong></td>
<td><code>ndarray</code></td>
<td></td>
<td>Insample forecasts of size (<code>base</code>, <code>insample_size</code>)</td>
</tr>
</tbody>
</table>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This reconciliation algorithm proposed by Wickramasuriya et al. depends on a generalized least squares estimator and an estimator of the covariance matrix of the coherency errors $\mathbf{W}_{h}$. The Min Trace algorithm minimizes the squared errors for the coherent forecasts under an unbiasedness assumption; the solution has a closed form.</p>
<p>{% raw %}
$$\mathbf{P}_{\text{MinT}} = \left(\mathbf{S}^{\intercal}\mathbf{W}_{h}\mathbf{S}\right)^{-1} \mathbf{S}^{\intercal} \mathbf{W}^{-1}_{h}$$
{% endraw %}</p>
<ul>
<li><a href="https://robjhyndman.com/publications/mint/">Wickramasuriya, S. L., Athanasopoulos, G., &amp; Hyndman, R. J. (2019). Optimal forecast reconciliation for hierarchical and grouped time series through trace minimization. Journal of the American Statistical Association, 114 , 804–819. doi:10.1080/01621459.2018.1448825.</a></li>
</ul>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="ERM" class="doc_header"><code>class</code> <code>ERM</code><a href="https://github.com/Nixtla/hierarchicalforecast/tree/main/hierarchicalforecast/methods.py#L404" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>ERM</code>(<strong><code>method</code></strong>:<code>str</code>, <strong><code>lambda_reg</code></strong>:<code>float</code>=<em><code>0.01</code></em>)</p>
</blockquote>
<table>
<thead><tr>
<th></th>
<th>Type</th>
<th>Default</th>
<th>Details</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong><code>method</code></strong></td>
<td><code>str</code></td>
<td></td>
<td>one of <code>closed</code>, <code>reg</code> and <code>reg_bu</code></td>
</tr>
<tr>
<td><strong><code>lambda_reg</code></strong></td>
<td><code>float</code></td>
<td><code>0.01</code></td>
<td>l1 regularizer for <code>reg</code> and <code>reg_bu</code></td>
</tr>
</tbody>
</table>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="ERM.reconcile" class="doc_header"><code>ERM.reconcile</code><a href="https://github.com/Nixtla/hierarchicalforecast/tree/main/hierarchicalforecast/methods.py#L414" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>ERM.reconcile</code>(<strong><code>S</code></strong>:<code>ndarray</code>, <strong><code>y_hat</code></strong>:<code>ndarray</code>, <strong><code>y_insample</code></strong>:<code>ndarray</code>, <strong><code>y_hat_insample</code></strong>:<code>ndarray</code>, <strong><code>idx_bottom</code></strong>:<code>ndarray</code>)</p>
</blockquote>
<table>
<thead><tr>
<th></th>
<th>Type</th>
<th>Default</th>
<th>Details</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong><code>S</code></strong></td>
<td><code>ndarray</code></td>
<td></td>
<td>Summing matrix of size (<code>base</code>, <code>bottom</code>)</td>
</tr>
<tr>
<td><strong><code>y_hat</code></strong></td>
<td><code>ndarray</code></td>
<td></td>
<td>Forecast values of size (<code>base</code>, <code>horizon</code>)</td>
</tr>
<tr>
<td><strong><code>y_insample</code></strong></td>
<td><code>ndarray</code></td>
<td></td>
<td>Insample values of size (<code>base</code>, <code>insample_size</code>)</td>
</tr>
<tr>
<td><strong><code>y_hat_insample</code></strong></td>
<td><code>ndarray</code></td>
<td></td>
<td>Insample forecasts of size (<code>base</code>, <code>insample_size</code>)</td>
</tr>
<tr>
<td><strong><code>idx_bottom</code></strong></td>
<td><code>ndarray</code></td>
<td></td>
<td>Indices corresponding to the bottom level of <code>S</code>, size (<code>bottom</code>)</td>
</tr>
</tbody>
</table>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The Empirical Risk Minimization reconciliation strategy relaxes the unbiasedness assumptions from
previous reconciliation methods like MinT and optimizes square errors between the reconciled predictions
and the validation data to obtain an optimal reconciliation matrix P.</p>
<p>The exact solution for $\mathbf{P}$ (<code>method='closed'</code>) follows the expression:</p>
<p>{% raw %}
$$\mathbf{P}^{*} = \left(\mathbf{S}^{\intercal}\mathbf{S}\right)^{-1}\mathbf{Y}^{\intercal}\hat{\mathbf{Y}}\left(\hat{\mathbf{Y}}\hat{\mathbf{Y}}\right)^{-1}$$
{% endraw %}</p>
<p>The alternative Lasso regularized $\mathbf{P}$ solution (<code>method='reg_bu'</code>) is useful when the observations of validation data is 
limited or the exact solution has low numerical stability.</p>
<p>{% raw %}
$$\mathbf{P}^{*} = \text{argmin}_{\mathbf{P}} ||\mathbf{Y}-\mathbf{S} \mathbf{P} \hat{Y} ||^{2}_{2} + \lambda ||\mathbf{P}-\mathbf{P}_{\text{BU}}||_{1}$$
{% endraw %}</p>
<ul>
<li><a href="https://doi.org/10.1145/3292500.3330976">Ben Taieb, S., &amp; Koo, B. (2019). Regularized regression for hierarchical forecasting without unbiasedness conditions. In Proceedings of the 25th ACM SIGKDD International Conference on Knowledge Discovery &amp; Data Mining KDD '19 (p. 1337{1347). New York, NY, USA: Association for Computing Machinery.</a></li>
</ul>

</div>
</div>
</div>
</div>


