---

title: Hierarchical Reconciliation for TourismSmall dataset


keywords: fastai
sidebar: home_sidebar



nb_path: "examples/TourismSmall.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: examples/TourismSmall.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><a href="https://colab.research.google.com/github/Nixtla/hierarchicalforecast/blob/main/examples/TourismSmall.ipynb" target="_parent"><img src="https://colab.research.google.com/assets/colab-badge.svg" alt="Open In Colab"/></a></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Large collections of time series organized into structures at different aggregation levels often require their forecasts to follow their aggregation constraints, which poses the challenge of creating novel algorithms capable of coherent forecasts.</p>
<p>The <code>HierarchicalForecast</code> package provides a wide collection of Python implementations of hierarchical forecasting algorithms that follow classic hierarchical reconciliation.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%capture</span>
<span class="err">!</span><span class="n">pip</span> <span class="n">install</span> <span class="n">hierarchicalforecast</span>
<span class="err">!</span><span class="n">pip</span> <span class="n">install</span> <span class="n">statsforecast</span> <span class="n">datasetsforecast</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="c1">#obtain hierarchical data</span>
<span class="kn">from</span> <span class="nn">datasetsforecast.hierarchical</span> <span class="kn">import</span> <span class="n">HierarchicalData</span>
<span class="c1">#obtain hierarchical reconciliation methods and evaluation</span>
<span class="kn">from</span> <span class="nn">hierarchicalforecast.core</span> <span class="kn">import</span> <span class="n">HierarchicalReconciliation</span>
<span class="kn">from</span> <span class="nn">hierarchicalforecast.evaluation</span> <span class="kn">import</span> <span class="n">HierarchicalEvaluation</span>
<span class="kn">from</span> <span class="nn">hierarchicalforecast.methods</span> <span class="kn">import</span> <span class="n">BottomUp</span><span class="p">,</span> <span class="n">TopDown</span><span class="p">,</span> <span class="n">MiddleOut</span>
<span class="c1"># compute base forecast no coherent</span>
<span class="kn">from</span> <span class="nn">statsforecast.core</span> <span class="kn">import</span> <span class="n">StatsForecast</span>
<span class="kn">from</span> <span class="nn">statsforecast.models</span> <span class="kn">import</span> <span class="n">auto_arima</span><span class="p">,</span> <span class="n">naive</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>In this example we will use the <code>TourismSmall</code> dataset. The following cell gets the time series for the different levels in the hierarchy, the summing matrix <code>S</code> which recovers the full dataset from the bottom level hierarchy and the indices of each hierarchy denoted by <code>tags</code>.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">Y_df</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">tags</span> <span class="o">=</span> <span class="n">HierarchicalData</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;./data&#39;</span><span class="p">,</span> <span class="s1">&#39;TourismSmall&#39;</span><span class="p">)</span>
<span class="n">Y_df</span><span class="p">[</span><span class="s1">&#39;ds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">Y_df</span><span class="p">[</span><span class="s1">&#39;ds&#39;</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">Y_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>unique_id</th>
      <th>ds</th>
      <th>y</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>total</td>
      <td>1998-03-31</td>
      <td>84503</td>
    </tr>
    <tr>
      <th>1</th>
      <td>total</td>
      <td>1998-06-30</td>
      <td>65312</td>
    </tr>
    <tr>
      <th>2</th>
      <td>total</td>
      <td>1998-09-30</td>
      <td>72753</td>
    </tr>
    <tr>
      <th>3</th>
      <td>total</td>
      <td>1998-12-31</td>
      <td>70880</td>
    </tr>
    <tr>
      <th>4</th>
      <td>total</td>
      <td>1999-03-31</td>
      <td>86893</td>
    </tr>
  </tbody>
</table>
</div></div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">S</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">5</span><span class="p">,</span> <span class="p">:</span><span class="mi">5</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>nsw-hol-city</th>
      <th>nsw-hol-noncity</th>
      <th>vic-hol-city</th>
      <th>vic-hol-noncity</th>
      <th>qld-hol-city</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>total</th>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>hol</th>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>vfr</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>bus</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>oth</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
</div></div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tags</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>{&#39;Country&#39;: array([&#39;total&#39;], dtype=object),
 &#39;Country/Purpose&#39;: array([&#39;hol&#39;, &#39;vfr&#39;, &#39;bus&#39;, &#39;oth&#39;], dtype=object),
 &#39;Country/Purpose/State&#39;: array([&#39;nsw-hol&#39;, &#39;vic-hol&#39;, &#39;qld-hol&#39;, &#39;sa-hol&#39;, &#39;wa-hol&#39;, &#39;tas-hol&#39;,
        &#39;nt-hol&#39;, &#39;nsw-vfr&#39;, &#39;vic-vfr&#39;, &#39;qld-vfr&#39;, &#39;sa-vfr&#39;, &#39;wa-vfr&#39;,
        &#39;tas-vfr&#39;, &#39;nt-vfr&#39;, &#39;nsw-bus&#39;, &#39;vic-bus&#39;, &#39;qld-bus&#39;, &#39;sa-bus&#39;,
        &#39;wa-bus&#39;, &#39;tas-bus&#39;, &#39;nt-bus&#39;, &#39;nsw-oth&#39;, &#39;vic-oth&#39;, &#39;qld-oth&#39;,
        &#39;sa-oth&#39;, &#39;wa-oth&#39;, &#39;tas-oth&#39;, &#39;nt-oth&#39;], dtype=object),
 &#39;Country/Purpose/State/CityNonCity&#39;: array([&#39;nsw-hol-city&#39;, &#39;nsw-hol-noncity&#39;, &#39;vic-hol-city&#39;,
        &#39;vic-hol-noncity&#39;, &#39;qld-hol-city&#39;, &#39;qld-hol-noncity&#39;,
        &#39;sa-hol-city&#39;, &#39;sa-hol-noncity&#39;, &#39;wa-hol-city&#39;, &#39;wa-hol-noncity&#39;,
        &#39;tas-hol-city&#39;, &#39;tas-hol-noncity&#39;, &#39;nt-hol-city&#39;, &#39;nt-hol-noncity&#39;,
        &#39;nsw-vfr-city&#39;, &#39;nsw-vfr-noncity&#39;, &#39;vic-vfr-city&#39;,
        &#39;vic-vfr-noncity&#39;, &#39;qld-vfr-city&#39;, &#39;qld-vfr-noncity&#39;,
        &#39;sa-vfr-city&#39;, &#39;sa-vfr-noncity&#39;, &#39;wa-vfr-city&#39;, &#39;wa-vfr-noncity&#39;,
        &#39;tas-vfr-city&#39;, &#39;tas-vfr-noncity&#39;, &#39;nt-vfr-city&#39;, &#39;nt-vfr-noncity&#39;,
        &#39;nsw-bus-city&#39;, &#39;nsw-bus-noncity&#39;, &#39;vic-bus-city&#39;,
        &#39;vic-bus-noncity&#39;, &#39;qld-bus-city&#39;, &#39;qld-bus-noncity&#39;,
        &#39;sa-bus-city&#39;, &#39;sa-bus-noncity&#39;, &#39;wa-bus-city&#39;, &#39;wa-bus-noncity&#39;,
        &#39;tas-bus-city&#39;, &#39;tas-bus-noncity&#39;, &#39;nt-bus-city&#39;, &#39;nt-bus-noncity&#39;,
        &#39;nsw-oth-city&#39;, &#39;nsw-oth-noncity&#39;, &#39;vic-oth-city&#39;,
        &#39;vic-oth-noncity&#39;, &#39;qld-oth-city&#39;, &#39;qld-oth-noncity&#39;,
        &#39;sa-oth-city&#39;, &#39;sa-oth-noncity&#39;, &#39;wa-oth-city&#39;, &#39;wa-oth-noncity&#39;,
        &#39;tas-oth-city&#39;, &#39;tas-oth-noncity&#39;, &#39;nt-oth-city&#39;, &#39;nt-oth-noncity&#39;],
       dtype=object)}</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We split the dataframe in train/test splits.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">Y_df_test</span> <span class="o">=</span> <span class="n">Y_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;unique_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
<span class="n">Y_df_train</span> <span class="o">=</span> <span class="n">Y_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">Y_df_test</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">Y_df_test</span> <span class="o">=</span> <span class="n">Y_df_test</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;unique_id&#39;</span><span class="p">)</span>
<span class="n">Y_df_train</span> <span class="o">=</span> <span class="n">Y_df_train</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;unique_id&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The following cell computes the <em>base forecast</em> for each time series using the <code>auto_arima</code> and <code>naive</code> models. Observe that <code>Y_hat_df</code> contains the forecasts but they are not coherent.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%capture</span>
<span class="n">fcst</span> <span class="o">=</span> <span class="n">StatsForecast</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">Y_df_train</span><span class="p">,</span> <span class="n">models</span><span class="o">=</span><span class="p">[(</span><span class="n">auto_arima</span><span class="p">,</span><span class="mi">12</span><span class="p">),</span> <span class="n">naive</span><span class="p">],</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">Y_hat_df</span> <span class="o">=</span> <span class="n">fcst</span><span class="o">.</span><span class="n">forecast</span><span class="p">(</span><span class="n">h</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>INFO:statsforecast.core:Computing forecasts
INFO:statsforecast.core:Computed forecasts for auto_arima_season_length-12.
INFO:statsforecast.core:Computed forecasts for naive.
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The following cell makes the previous forecasts coherent using the <a href="/hierarchicalforecast/core.html#HierarchicalReconciliation"><code>HierarchicalReconciliation</code></a> class. The used methods to make the forecasts coherent are:</p>
<ul>
<li><a href="/hierarchicalforecast/methods.html#BottomUp"><code>BottomUp</code></a>: The reconciliation of the method is a simple addition to the upper levels.</li>
<li><a href="/hierarchicalforecast/methods.html#TopDown"><code>TopDown</code></a>: The second method constrains the base-level predictions to the top-most aggregate-level serie and then distributes it to the disaggregate series through the use of proportions. </li>
<li><a href="/hierarchicalforecast/methods.html#MiddleOut"><code>MiddleOut</code></a>: Anchors the base predictions in a middle level.</li>
</ul>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">reconcilers</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">BottomUp</span><span class="p">(),</span>
    <span class="n">TopDown</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;forecast_proportions&#39;</span><span class="p">),</span>
    <span class="n">MiddleOut</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;Country/Purpose/State&#39;</span><span class="p">,</span> <span class="n">top_down_method</span><span class="o">=</span><span class="s1">&#39;forecast_proportions&#39;</span><span class="p">)</span>
<span class="p">]</span>
<span class="n">hrec</span> <span class="o">=</span> <span class="n">HierarchicalReconciliation</span><span class="p">(</span><span class="n">reconcilers</span><span class="o">=</span><span class="n">reconcilers</span><span class="p">)</span>
<span class="n">Y_rec_df</span> <span class="o">=</span> <span class="n">hrec</span><span class="o">.</span><span class="n">reconcile</span><span class="p">(</span><span class="n">Y_hat_df</span><span class="p">,</span> <span class="n">Y_df_train</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">tags</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The <code>HierarchicalForecast</code> package includes the <a href="/hierarchicalforecast/evaluation.html#HierarchicalEvaluation"><code>HierarchicalEvaluation</code></a> class to evaluate the different hierarchies and also is capable of compute scaled metrics compared to a benchmark model.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">mse</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">y_hat</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">y</span><span class="o">-</span><span class="n">y_hat</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

<span class="n">evaluator</span> <span class="o">=</span> <span class="n">HierarchicalEvaluation</span><span class="p">(</span><span class="n">evaluators</span><span class="o">=</span><span class="p">[</span><span class="n">mse</span><span class="p">])</span>
<span class="n">evaluation</span> <span class="o">=</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span>
        <span class="n">Y_h</span><span class="o">=</span><span class="n">Y_rec_df</span><span class="p">,</span> <span class="n">Y_test</span><span class="o">=</span><span class="n">Y_df_test</span><span class="p">,</span> 
        <span class="n">tags</span><span class="o">=</span><span class="n">tags</span><span class="p">,</span> <span class="n">benchmark</span><span class="o">=</span><span class="s1">&#39;naive&#39;</span>
<span class="p">)</span>
<span class="n">evaluation</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">like</span><span class="o">=</span><span class="s1">&#39;arima&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th>level</th>
      <th>Overall</th>
      <th>Country</th>
      <th>Country/Purpose</th>
      <th>Country/Purpose/State</th>
      <th>Country/Purpose/State/CityNonCity</th>
    </tr>
    <tr>
      <th>metric</th>
      <th>mse-scaled</th>
      <th>mse-scaled</th>
      <th>mse-scaled</th>
      <th>mse-scaled</th>
      <th>mse-scaled</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>auto_arima_season_length-12</th>
      <td>0.958433</td>
      <td>1.05191</td>
      <td>0.903941</td>
      <td>0.909366</td>
      <td>0.84693</td>
    </tr>
    <tr>
      <th>auto_arima_season_length-12/BottomUp</th>
      <td>0.908254</td>
      <td>0.978696</td>
      <td>0.861644</td>
      <td>0.867018</td>
      <td>0.84693</td>
    </tr>
    <tr>
      <th>auto_arima_season_length-12/TopDown_method-forecast_proportions</th>
      <td>0.973065</td>
      <td>1.05191</td>
      <td>0.887653</td>
      <td>0.973846</td>
      <td>0.949697</td>
    </tr>
    <tr>
      <th>auto_arima_season_length-12/MiddleOut_level-Country/Purpose/State_top_down_method-forecast_proportions</th>
      <td>0.896154</td>
      <td>0.950772</td>
      <td>0.830192</td>
      <td>0.909366</td>
      <td>0.885367</td>
    </tr>
  </tbody>
</table>
</div></div>

</div>

</div>
</div>

</div>
    {% endraw %}

</div>


